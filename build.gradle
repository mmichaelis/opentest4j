import java.text.SimpleDateFormat

buildscript {
	repositories {
		maven {
			url 'https://plugins.gradle.org/m2/'
		}
	}
	dependencies {
		classpath 'com.diffplug.gradle.spotless:spotless:1.3.2'
		classpath 'org.asciidoctor:asciidoctor-gradle-plugin:1.5.3'
		classpath 'org.ajoberstar:gradle-git:1.3.2'
		classpath "be.insaneprogramming.gradle:animalsniffer-gradle-plugin:+"
		classpath 'net.nemerosa:versioning:1.7.1'
	}
}

Date buildTimeAndDate = new Date()
ext {
	buildDate = new SimpleDateFormat('yyyy-MM-dd').format(buildTimeAndDate)
	buildTime = new SimpleDateFormat('HH:mm:ss.SSSZ').format(buildTimeAndDate)
	builtByValue = project.hasProperty('builtBy') ? project.builtBy : project.defaultBuiltBy
}

apply plugin: 'java'
apply plugin: 'eclipse'
apply plugin: 'idea'
apply plugin: 'maven'
apply plugin: 'signing'
apply plugin: 'com.diffplug.gradle.spotless'
apply plugin: 'be.insaneprogramming.gradle.animalsniffer'
apply plugin: 'net.nemerosa.versioning'

description = 'Open Test Alliance for the JVM'

repositories {
	mavenCentral()
}

compileJava {
	// please also update accordingly the animalsniffer config down below when changing the compatibility settings
	sourceCompatibility = 1.6
	targetCompatibility = 1.6
}

compileTestJava {
	sourceCompatibility = 1.6
	targetCompatibility = 1.6
}

dependencies {
	testCompile("junit:junit:${junit4Version}")
}

test {
	testLogging {
		exceptionFormat = 'full'
	}
}

def normalizeVersion = { versionLiteral ->
	try {
		(versionLiteral =~ /(\d+)\.(\d+)\.(\d+).*/)[0][1..3].join('.')
	} catch(x) {
		throw new GradleException("Version '$versionLiteral' does not match version pattern, e.g. 1.0.0-QUALIFIER")
	}
}

jar {
	manifest {
		attributes(
			'Created-By': "${System.properties['java.version']} (${System.properties['java.vendor']} ${System.properties['java.vm.version']})".toString(),
			'Built-By': builtByValue,
			'Build-Date': buildDate,
			'Build-Time': buildTime,
			'Build-Revision': versioning.info.commit,
			'Specification-Title': project.name,
			'Specification-Version': normalizeVersion(project.version),
			'Specification-Vendor': 'opentest4j.org',
			'Implementation-Title': project.name,
			'Implementation-Version': project.version,
			'Implementation-Vendor': 'opentest4j.org'
		)
	}
}

javadoc {
	options.memberLevel = org.gradle.external.javadoc.JavadocMemberLevel.PROTECTED
	options.author = true
	options.header = 'Open Test Alliance for the JVM'
	options.addStringOption('Xdoclint:none', '-quiet')
}

task sourcesJar(type: Jar, dependsOn: classes) {
	classifier = 'sources'
	from sourceSets.main.allSource
}

task javadocJar(type: Jar) {
	classifier = 'javadoc'
	from javadoc
}

artifacts {
	archives sourcesJar
	archives javadocJar
}

spotless {
	java {
		licenseHeaderFile rootProject.file('etc/spotless/apache-license-2.0.java')
		importOrder(['java', 'javax', 'com', 'org'])
		eclipseFormatFile rootProject.file('etc/eclipse/eclipse-formatter-settings.xml')

		trimTrailingWhitespace()
		endWithNewline()

		custom 'Lambda fix', { it.replace('} )', '})').replace('} ,', '},') }
	}
}

animalsniffer {
	signature = "org.codehaus.mojo.signature:java16:+@signature"
}

def signArtifacts = !project.version.contains('SNAPSHOT')

if (signArtifacts) {
	signing {
		sign configurations.archives
	}
}

uploadArchives {

	dependsOn check

	repositories {
		mavenDeployer {

			if (signArtifacts) {
				beforeDeployment { MavenDeployment deployment -> signing.signPom(deployment) }
			}

			def ossrhUsername = rootProject.hasProperty('ossrhUsername') ? rootProject.ossrhUsername : ''
			def ossrhPassword = rootProject.hasProperty('ossrhPassword') ? rootProject.ossrhPassword : ''

			repository(url: "https://oss.sonatype.org/service/local/staging/deploy/maven2/") {
				authentication(userName: ossrhUsername, password: ossrhPassword)
			}

			snapshotRepository(url: "https://oss.sonatype.org/content/repositories/snapshots/") {
				authentication(userName: ossrhUsername, password: ossrhPassword)
			}

			pom.project {
				name "${project.group}:${project.name}"
				packaging 'jar'
				description "Open Test Alliance for the JVM"
				url 'https://github.com/ota4j-team/opentest4j'

				scm {
					connection 'scm:git:git://github.com/ota4j-team/opentest4j.git'
					developerConnection 'scm:git:git://github.com/ota4j-team/opentest4j.git'
					url 'https://github.com/ota4j-team/opentest4j'
				}

				licenses {
					license {
						name 'The Apache License, Version 2.0'
						url 'http://www.apache.org/licenses/LICENSE-2.0.txt'
					}
				}

				developers {
					developer {
						id 'bechte'
						name 'Stefan Bechtold'
						email 'stefan.bechtold@me.com'
					}
					developer {
						id 'jlink'
						name 'Johannes Link'
						email 'business@johanneslink.net'
					}
					developer {
						id 'marcphilipp'
						name 'Marc Philipp'
						email 'mail@marcphilipp.de'
					}
					developer {
						id 'mmerdes'
						name 'Matthias Merdes'
						email 'Matthias.Merdes@heidelberg-mobil.com'
					}
					developer {
						id 'sbrannen'
						name 'Sam Brannen'
						email 'sam@sambrannen.com'
					}
				}
			}
		}
	}
}

spotless {
	format 'misc', {
		target project.fileTree(project.rootDir) {
			include '**/*.gradle', '**/*.md', '**/*.gitignore'
			exclude '.gradle/**/*.*'
		}
		indentWithTabs()
		trimTrailingWhitespace()
		endWithNewline()
	}
}

task wrapper(type: Wrapper) {
	distributionUrl = 'https://services.gradle.org/distributions/gradle-2.14-bin.zip'
}
